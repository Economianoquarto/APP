<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Caio Lopes">
<meta name="dcterms.date" content="2025-04-19">

<title>APP - Pareamento</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">APP</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Pareamento</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Ensino</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Caio Lopes </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 19, 2025</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="o-problema-dos-confounders" class="level1">
<h1>1. O Problema dos Confounders</h1>
<section id="motivação-avaliação-de-treinamento-corporativo" class="level2">
<h2 class="anchored" data-anchor-id="motivação-avaliação-de-treinamento-corporativo">Motivação: Avaliação de Treinamento Corporativo</h2>
<p><strong>Pergunta de pesquisa</strong>: Programas de treinamento corporativo aumentam a produtividade dos funcionários?</p>
<p><strong>Variáveis</strong>: - <strong>Y</strong>: Produtividade mensal (R$ mil) - <strong>D</strong>: Participação em treinamento (0/1) - <strong>X</strong>: Experiência no cargo (anos)</p>
</section>
<section id="por-que-experiência-é-um-confounder" class="level2">
<h2 class="anchored" data-anchor-id="por-que-experiência-é-um-confounder">Por que Experiência é um Confounder?</h2>
<p><strong>Definição</strong>: Um confounder é uma variável que afeta tanto o tratamento quanto o resultado.</p>
<p>No nosso exemplo:</p>
<ol type="1">
<li><p><strong>Experiência → Treinamento</strong>: Funcionários inexperientes são mais enviados para treinamento</p></li>
<li><p><strong>Experiência → Produtividade</strong>: Funcionários experientes são naturalmente mais produtivos</p></li>
</ol>
<p><strong>Conclusão</strong>: não levar em conta o confounder (experiência) causa endogeneidade (viés de variável obtida).</p>
</section>
<section id="simulação-do-problema" class="level2">
<h2 class="anchored" data-anchor-id="simulação-do-problema">Simulação do Problema</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matching)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">800</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Gerar dados com confounding negativo</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>dados <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Experiência (confounder)</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">experiencia =</span> <span class="fu">pmax</span>(<span class="dv">0</span>, <span class="fu">rgamma</span>(n, <span class="at">shape =</span> <span class="dv">2</span>, <span class="at">rate =</span> <span class="fl">0.4</span>)),</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Probabilidade de treinamento (maior para inexperientes)</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob_treinamento =</span> <span class="fu">plogis</span>(<span class="fl">1.5</span> <span class="sc">-</span> <span class="fl">0.3</span> <span class="sc">*</span> experiencia),</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">treinamento =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, prob_treinamento),</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Produtividade (depende de experiência E treinamento)</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Efeito verdadeiro do treinamento: +15 mil</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">produtividade =</span> <span class="dv">25</span> <span class="sc">+</span> <span class="dv">8</span> <span class="sc">*</span> experiencia <span class="sc">+</span> <span class="dv">15</span> <span class="sc">*</span> treinamento <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">produtividade =</span> <span class="fu">pmax</span>(<span class="dv">5</span>, produtividade))</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Estatísticas por grupo</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>dados <span class="sc">%&gt;%</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(treinamento) <span class="sc">%&gt;%</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">experiencia_media =</span> <span class="fu">round</span>(<span class="fu">mean</span>(experiencia), <span class="dv">1</span>),</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">produtividade_media =</span> <span class="fu">round</span>(<span class="fu">mean</span>(produtividade), <span class="dv">1</span>),</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">grupo =</span> <span class="fu">c</span>(<span class="st">"Sem Treinamento"</span>, <span class="st">"Com Treinamento"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(grupo, <span class="fu">everything</span>(), <span class="sc">-</span>treinamento) <span class="sc">%&gt;%</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">grupo</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">experiencia_media</th>
<th style="text-align: right;">produtividade_media</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Sem Treinamento</td>
<td style="text-align: right;">383</td>
<td style="text-align: right;">5.9</td>
<td style="text-align: right;">71.6</td>
</tr>
<tr class="even">
<td style="text-align: left;">Com Treinamento</td>
<td style="text-align: right;">417</td>
<td style="text-align: right;">3.5</td>
<td style="text-align: right;">68.1</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="o-problema-revelado" class="level2">
<h2 class="anchored" data-anchor-id="o-problema-revelado">O Problema Revelado</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Análise ingênua (INCORRETA)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>diferenca_ingenua <span class="ot">&lt;-</span> dados <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(treinamento) <span class="sc">%&gt;%</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">prod_media =</span> <span class="fu">mean</span>(produtividade)) <span class="sc">%&gt;%</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">diferenca =</span> <span class="fu">diff</span>(prod_media)) <span class="sc">%&gt;%</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(diferenca)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Efeito aparente (sem controles):"</span>, <span class="fu">round</span>(diferenca_ingenua, <span class="dv">1</span>), <span class="st">"mil reais </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Efeito aparente (sem controles): -3.5 mil reais </code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Efeito verdadeiro (por construção): +15.0 mil reais </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Efeito verdadeiro (por construção): +15.0 mil reais </code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Conclusão errônea: 'Treinamento não funciona!'"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Conclusão errônea: 'Treinamento não funciona!'</code></pre>
</div>
</div>
<p><strong>Visualização do problema</strong>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> dados <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(treinamento), <span class="at">y =</span> experiencia)) <span class="sc">+</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Funcionários treinados têm menos experiência"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Treinamento"</span>, <span class="at">y =</span> <span class="st">"Experiência (anos)"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> dados <span class="sc">%&gt;%</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> experiencia, <span class="at">y =</span> produtividade, <span class="at">color =</span> <span class="fu">factor</span>(treinamento))) <span class="sc">+</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Experiência confunde a relação"</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Experiência (anos)"</span>, <span class="at">y =</span> <span class="st">"Produtividade (R$ mil)"</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Treinamento"</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pacote 'gridExtra' foi compilado no R versão 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Anexando pacote: 'gridExtra'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>O seguinte objeto é mascarado por 'package:dplyr':

    combine</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/viz-problema-1.png" class="img-fluid" width="960"></p>
</div>
</div>
</section>
</section>
<section id="como-o-pareamento-corrige-o-problema" class="level1">
<h1>2. Como o Pareamento Corrige o Problema</h1>
<section id="intuição-básica" class="level2">
<h2 class="anchored" data-anchor-id="intuição-básica">Intuição Básica</h2>
<p><strong>Ideia central</strong>: Comparar funcionários similares que diferem apenas no tratamento.</p>
<p><strong>Estratégia</strong>:</p>
<ul>
<li><p>Encontrar funcionários com mesma experiência</p></li>
<li><p>Alguns receberam treinamento, outros não</p></li>
<li><p>Calcular diferença na produtividade</p></li>
</ul>
</section>
<section id="framework-de-resultados-potenciais" class="level2">
<h2 class="anchored" data-anchor-id="framework-de-resultados-potenciais">Framework de Resultados Potenciais</h2>
<p>Para cada funcionário <span class="math inline">\(i\)</span>:</p>
<ul>
<li><p><span class="math inline">\(Y_i^1\)</span>: produtividade se recebe treinamento</p></li>
<li><p><span class="math inline">\(Y_i^0\)</span>: produtividade se não recebe treinamento</p></li>
<li><p><span class="math inline">\(D_i\)</span>: indicador de treinamento</p></li>
<li><p><span class="math inline">\(X_i\)</span>: experiência</p></li>
</ul>
<p><strong>Suposição de Independência Condicional (CIA)</strong>: <span class="math display">\[(Y_i^1, Y_i^0) \perp D_i | X_i\]</span></p>
<p><strong>Interpretação</strong>: Condicionalmente à experiência, a seleção para treinamento é “como se fosse” aleatória.</p>
</section>
<section id="demonstração-subclassificação-manual" class="level2">
<h2 class="anchored" data-anchor-id="demonstração-subclassificação-manual">Demonstração: Subclassificação Manual</h2>
<p>A subclassificação consiste em estimar o efeito do tratamento pela soma da diferença ponderada entre tratados e controles. A ponderação permite lidar com o problema de “covariates imbalance” (diferença na distribuição dos X’s entre os grupos).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Criar 4 estratos de experiência (simplificado)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>dados <span class="ot">&lt;-</span> dados <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">estrato_exp =</span> <span class="fu">case_when</span>(</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    experiencia <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Muito Inexperiente"</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    experiencia <span class="sc">&lt;</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"Inexperiente"</span>, </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    experiencia <span class="sc">&lt;</span> <span class="dv">7</span> <span class="sc">~</span> <span class="st">"Intermediário"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Experiente"</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar distribuição dos estratos</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>dados <span class="sc">%&gt;%</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(estrato_exp, treinamento) <span class="sc">%&gt;%</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> treinamento, <span class="at">values_from =</span> n, <span class="at">names_prefix =</span> <span class="st">"treinamento_"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Estrato"</span>, <span class="st">"Sem Treinamento"</span>, <span class="st">"Com Treinamento"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">Estrato</th>
<th style="text-align: right;">Sem Treinamento</th>
<th style="text-align: right;">Com Treinamento</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Experiente</td>
<td style="text-align: right;">126</td>
<td style="text-align: right;">28</td>
</tr>
<tr class="even">
<td style="text-align: left;">Inexperiente</td>
<td style="text-align: right;">98</td>
<td style="text-align: right;">140</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intermediário</td>
<td style="text-align: right;">117</td>
<td style="text-align: right;">127</td>
</tr>
<tr class="even">
<td style="text-align: left;">Muito Inexperiente</td>
<td style="text-align: right;">42</td>
<td style="text-align: right;">122</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular efeito dentro de cada estrato</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>efeitos_por_estrato <span class="ot">&lt;-</span> dados <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(estrato_exp) <span class="sc">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_tratados =</span> <span class="fu">sum</span>(treinamento),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_controles =</span> <span class="fu">sum</span>(<span class="dv">1</span> <span class="sc">-</span> treinamento),</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">efeito =</span> <span class="fu">mean</span>(produtividade[treinamento <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">-</span> </span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mean</span>(produtividade[treinamento <span class="sc">==</span> <span class="dv">0</span>]),</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>efeitos_por_estrato <span class="sc">%&gt;%</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>, <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Estrato"</span>, <span class="st">"N Total"</span>, <span class="st">"N Tratados"</span>, <span class="st">"N Controles"</span>, <span class="st">"Efeito (R$ mil)"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">Estrato</th>
<th style="text-align: right;">N Total</th>
<th style="text-align: right;">N Tratados</th>
<th style="text-align: right;">N Controles</th>
<th style="text-align: right;">Efeito (R$ mil)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Experiente</td>
<td style="text-align: right;">154</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">126</td>
<td style="text-align: right;">3.98</td>
</tr>
<tr class="even">
<td style="text-align: left;">Inexperiente</td>
<td style="text-align: right;">238</td>
<td style="text-align: right;">140</td>
<td style="text-align: right;">98</td>
<td style="text-align: right;">15.04</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intermediário</td>
<td style="text-align: right;">244</td>
<td style="text-align: right;">127</td>
<td style="text-align: right;">117</td>
<td style="text-align: right;">14.47</td>
</tr>
<tr class="even">
<td style="text-align: left;">Muito Inexperiente</td>
<td style="text-align: right;">164</td>
<td style="text-align: right;">122</td>
<td style="text-align: right;">42</td>
<td style="text-align: right;">14.11</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Efeito médio ponderado</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>ate_corrigido <span class="ot">&lt;-</span> efeitos_por_estrato <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">peso =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">ate =</span> <span class="fu">sum</span>(efeito <span class="sc">*</span> peso)) <span class="sc">%&gt;%</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ate)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Efeito corrigido:"</span>, <span class="fu">round</span>(ate_corrigido, <span class="dv">2</span>), <span class="st">"mil reais"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Efeito corrigido: 12.55 mil reais</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Agora recuperamos algo próximo do efeito verdadeiro"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Agora recuperamos algo próximo do efeito verdadeiro</code></pre>
</div>
</div>
<p>Nesse caso estamos calculando o ATE a partir de 4 estratos da nossa amostra:</p>
<ul>
<li>A: Inexperiente</li>
<li>B: Experiente</li>
<li>C: Intermediário</li>
<li>D: Muito Inexperiente</li>
</ul>
<p>O calculo do ATE foi baseado na soma ponderada de cada estrato da amostra:</p>
<p><span class="math display">\[
ATE =
\left ( \bar{Y}^{1,A} - \bar{Y}^{0,A} \right ) \frac{N^{A}}{N} +
\left ( \bar{Y}^{1,B} - \bar{Y}^{0,B} \right ) \frac{N^{B}}{N} +
\left ( \bar{Y}^{1,C} - \bar{Y}^{0,C} \right ) \frac{N^{C}}{N} +
\left ( \bar{Y}^{1,D} - \bar{Y}^{0,D} \right ) \frac{N^{D}}{N}
\]</span> Imagine que exista outro confundidor: o regime de trabalho. Os trabalhadores CLT são mais engajados em participar do treinamento, mas tendem a ser menos produtivos. Já os trabalhadores PJ são menos engajados em participar do treinamento, mas tendem a ser mais produtivos.Nesse casos, considerando as classificações de experiencia e de regime de trabalho, temos 8 estratos:</p>
<ul>
<li>A1: Inexperiente e CLT</li>
<li>A2: Inexperiente e PJ</li>
<li>B1: Experiente e CLT</li>
<li>B2: Experiente e PJ</li>
<li>C1: Intermediário e CLT</li>
<li>C2: Intermediário e PJ</li>
<li>D1: Muito Inexperiente e CLT</li>
<li>D2: Muito Inexperiente e PJ</li>
</ul>
<p>A medida que as variáveis de controle aumentam, começamos a ter dificuldade em colocar cada unidade (tratada ou não) em uma “caixinha” do X’s. Se a variável confundidora não for discreta (e.g.&nbsp;experiência em anos) a dificuldade aumenta.</p>
<p>Nesses casos, estimar o ATT pode ser mais fácil. Por exemplo, digamos que você não consegue colocar todas as unidades tratadas em um estrato, mas consegue colocar todas do grupo de controle. Logo, para cada estrato de unidade tratada você poderá construir um contrafactual (mas você não conseguirá um contrafactual par a grupo controle).</p>
<p><span class="math display">\[
ATT = \sum^{K}_{k=1}
\left ( \bar{Y}^{1,k} - \bar{Y}^{0,k} \right ) \frac{N^{k}_{T}}{N_{T}}
\]</span> Este problema causado pela dimensionalidade é um problema de suporte comum. Alternativamente, se preenchêssemos o resultado potencial ausente para cada unidade de tratamento usando uma unidade do grupo de controle que fosse “mais próxima” da unidade do grupo de tratamento para algum fator de confusão, poderíamos simplesmente calcular a média das diferenças. Esse método é conhecido como pareamento.</p>
</section>
</section>
<section id="principais-tipos-de-pareamento" class="level1">
<h1>3. Principais Tipos de Pareamento</h1>
<section id="pareamento-exato" class="level2">
<h2 class="anchored" data-anchor-id="pareamento-exato">3.1 Pareamento Exato</h2>
<p><strong>Definição</strong>: Parear unidades com valores idênticos das covariáveis.</p>
<p><strong>Vantagens</strong>: - Transparente e fácil de entender - Balance perfeito por construção - Não requer suposições funcionais</p>
<p><strong>Desvantagens</strong>: - Maldição da dimensionalidade - Perda de observações - Só funciona com covariáveis categóricas</p>
</section>
<section id="pareamento-aproximado" class="level2">
<h2 class="anchored" data-anchor-id="pareamento-aproximado">3.2 Pareamento Aproximado</h2>
<p><strong>Motivação</strong>: Quando pareamento exato não é viável, pois tenho covariadas contínuas ou um conjunto de covariadas.</p>
<p><strong>Estratégias</strong>: - Nearest neighbor matching - Caliper matching</p>
<p>O estimador do paraemento “1 para 1” é definido por: <span class="math display">\[
ATT = \frac{1}{N_{T}}\sum_{d_{i}=1}\left (Y_{i} - Y_{j(i)} \right )
\]</span> Em que a unidade <span class="math inline">\(j\)</span> é a unidade do grupo controle “mais próxima em termos de X” da unidade <span class="math inline">\(i\)</span> do grupo tratado. Este estimador computa o ATT, pois a média é condicional a <span class="math inline">\(d_{i}=1\)</span>.</p>
<p>Se no grupo controle encontrarmos mais de uma unidade parecida com a unidade tratada em termos dos Xs, podemos usar a média.</p>
<p><span class="math display">\[
ATT = \frac{1}{N_{T}}\sum_{d_{i}=1}\left (Y_{i} - \left [\frac{1}{M} \sum^{M}_{m=1} Y_{j_{m}(i) } \right ] \right )
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>dados<span class="sc">$</span>numeric_estrato_exp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(dados<span class="sc">$</span>estrato_exp))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>M1_att <span class="ot">&lt;-</span> <span class="fu">Match</span>(<span class="at">Y =</span> dados<span class="sc">$</span>produtividade, </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">Tr =</span> dados<span class="sc">$</span>treinamento, </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">X =</span> dados<span class="sc">$</span>experiencia,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">M =</span> <span class="dv">1</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">estimand=</span><span class="st">'ATT'</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(M1_att) <span class="co"># The default estimate is ATT here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Estimate...  15.406 
AI SE......  0.94063 
T-stat.....  16.379 
p.val......  &lt; 2.22e-16 

Original number of observations..............  800 
Original number of treated obs...............  417 
Matched number of observations...............  417 
Matched number of observations  (unweighted).  600 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>pares_detalhado <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">tratado_id    =</span> M1_att<span class="sc">$</span>index.treated,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">controle_id   =</span> M1_att<span class="sc">$</span>index.control,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">produtividade_tratado =</span> dados<span class="sc">$</span>produtividade[M1_att<span class="sc">$</span>index.treated],</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">produtividade_controle =</span> dados<span class="sc">$</span>produtividade[M1_att<span class="sc">$</span>index.control],</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">X_tratado =</span> dados<span class="sc">$</span>experiencia[M1_att<span class="sc">$</span>index.treated],</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">X_controle =</span> dados<span class="sc">$</span>experiencia[M1_att<span class="sc">$</span>index.control]</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pares_detalhado)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  tratado_id controle_id produtividade_tratado produtividade_controle X_tratado
1          3           8              56.66426               19.52045 0.3609374
2          4         388              76.77873               60.26301 4.1563083
3          7         433              59.62470               35.35006 0.8767943
4         10         326              71.28918               59.01813 4.9326166
5         10         402              71.28918               59.50021 4.9326166
6         13           1              59.29248               37.74784 2.2411907
  X_controle
1  0.3260003
2  4.1818486
3  0.8471077
4  4.9292527
5  4.9417003
6  2.2302339</code></pre>
</div>
</div>
<p>Perceba que: o tratado 3 pareou com o controle 8, o tratado 4 com o controle 388, etc. Vamos definir um M=3.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>M3_att <span class="ot">&lt;-</span> <span class="fu">Match</span>(<span class="at">Y =</span> dados<span class="sc">$</span>produtividade, </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">Tr =</span> dados<span class="sc">$</span>treinamento, </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">X =</span> dados<span class="sc">$</span>experiencia,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">M =</span> <span class="dv">3</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">estimand=</span><span class="st">'ATT'</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(M3_att) <span class="co"># The default estimate is ATT here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Estimate...  15.244 
AI SE......  0.84785 
T-stat.....  17.98 
p.val......  &lt; 2.22e-16 

Original number of observations..............  800 
Original number of treated obs...............  417 
Matched number of observations...............  417 
Matched number of observations  (unweighted).  1303 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>pares_detalhado_M3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">tratado_id    =</span> M3_att<span class="sc">$</span>index.treated,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">controle_id   =</span> M3_att<span class="sc">$</span>index.control,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">produtividade_tratado =</span> dados<span class="sc">$</span>produtividade[M3_att<span class="sc">$</span>index.treated],</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">produtividade_controle =</span> dados<span class="sc">$</span>produtividade[M3_att<span class="sc">$</span>index.control],</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">X_tratado =</span> dados<span class="sc">$</span>experiencia[M3_att<span class="sc">$</span>index.treated],</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">X_controle =</span> dados<span class="sc">$</span>experiencia[M3_att<span class="sc">$</span>index.control]</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pares_detalhado_M3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  tratado_id controle_id produtividade_tratado produtividade_controle X_tratado
1          3           8              56.66426               19.52045 0.3609374
2          3         594              56.66426               26.65428 0.3609374
3          3         690              56.66426               58.48778 0.3609374
4          4         365              76.77873               65.01573 4.1563083
5          4         388              76.77873               60.26301 4.1563083
6          4         425              76.77873               61.86003 4.1563083
  X_controle
1  0.3260003
2  0.4281087
3  0.4083420
4  4.1860628
5  4.1818486
6  4.1227288</code></pre>
</div>
</div>
<p>Perceba que: o tratado 3 pareou com o controle 8, 594 e 690; o tratado 4 com o controle 365, 388 e 425, etc. Vamos definir um M=3.</p>
<p>É possível calcular o ATE usando o pareamento. O estimador é dado por: <span class="math display">\[
ATE = \frac{1}{N}\sum_{i=1}^{N} (2D_{i}-1) \left (Y_{i} - \left [\frac{1}{M} \sum^{M}_{m=1} Y_{j_{m}(i) } \right ] \right )
\]</span> Quando <span class="math inline">\(D_{i}=1\)</span>, então esse termo principal se torna 1. E quando <span class="math inline">\(D_{i}=0\)</span>, então esse termo principal se torna -1, e os resultados invertem a ordem para que a observação do tratamento possa ser imputada.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>M3_ate <span class="ot">&lt;-</span> <span class="fu">Match</span>(<span class="at">Y =</span> dados<span class="sc">$</span>produtividade, </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">Tr =</span> dados<span class="sc">$</span>treinamento, </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">X =</span> dados<span class="sc">$</span>experiencia,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">M =</span> <span class="dv">3</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">estimand=</span><span class="st">'ATE'</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(M3_ate) <span class="co"># The default estimate is ATT here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Estimate...  14.814 
AI SE......  0.84969 
T-stat.....  17.434 
p.val......  &lt; 2.22e-16 

Original number of observations..............  800 
Original number of treated obs...............  417 
Matched number of observations...............  800 
Matched number of observations  (unweighted).  2536 </code></pre>
</div>
</div>
<p>Quando temos muitas covariadas, podemos usar um criterio para medir a distancia entre elas e definir um caliper</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>Maha_att <span class="ot">&lt;-</span> <span class="fu">Match</span>(<span class="at">Y =</span> dados<span class="sc">$</span>produtividade, </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">Tr =</span> dados<span class="sc">$</span>treinamento, </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">X =</span> dados<span class="sc">$</span>experiencia,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">caliper  =</span> .<span class="dv">25</span>,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">Weight =</span> <span class="dv">2</span>, <span class="co">#mahalanobis</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">estimand=</span><span class="st">'ATT'</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(Maha_att) <span class="co"># The default estimate is ATT here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Estimate...  15.406 
AI SE......  0.94063 
T-stat.....  16.379 
p.val......  &lt; 2.22e-16 

Original number of observations..............  800 
Original number of treated obs...............  417 
Matched number of observations...............  417 
Matched number of observations  (unweighted).  600 

Caliper (SDs)........................................   0.25 
Number of obs dropped by 'exact' or 'caliper'  0 </code></pre>
</div>
</div>
<ul>
<li>Distância Euclidiana</li>
</ul>
<p><strong>Conceito</strong>: Distância “em linha reta” no espaço multidimensional.</p>
<p><strong>Fórmula</strong>: <span class="math inline">\(d = \sqrt{\sum_{k=1}^p (x_{1k} - x_{2k})^2}\)</span></p>
<p>onde <span class="math inline">\(k\)</span> é o número de covariadas</p>
<p><strong>Quando usar</strong>: Poucas variáveis com escalas similares.</p>
<ul>
<li>Distância Mahalanobis</li>
</ul>
<p><strong>Conceito</strong>: Distância que considera a estrutura de correlação dos dados.</p>
<p><strong>Fórmula</strong>: <span class="math inline">\(d = \sqrt{(x_1 - x_2)^T S^{-1} (x_1 - x_2)}\)</span></p>
<p>onde <span class="math inline">\(S\)</span> é a matriz de covariância.</p>
<p><strong>Quando usar</strong>: Múltiplas covariáveis correlacionadas.</p>
<p>O <code>caliper</code> define o <strong>limite máximo de distância</strong> para aceitar um pareamento. É como um “raio de busca” - só forma pares dentro desse raio.</p>
</section>
<section id="propensity-score-matching" class="level2">
<h2 class="anchored" data-anchor-id="propensity-score-matching">3.3 Propensity Score Matching</h2>
<p><strong>Ideia revolucionária</strong> (Rosenbaum &amp; Rubin, 1983): Reduzir dimensionalidade usando probabilidade de tratamento.</p>
<p><strong>Propensity Score</strong>: <span class="math inline">\(e(X) = P(D = 1 | X)\)</span></p>
<p><strong>Teorema</strong>: Se <span class="math inline">\((Y^1, Y^0) \perp D | X\)</span>, então <span class="math inline">\((Y^1, Y^0) \perp D | e(X)\)</span></p>
<section id="passos-do-propensity-score-matching" class="level3">
<h3 class="anchored" data-anchor-id="passos-do-propensity-score-matching">Passos do Propensity Score Matching:</h3>
<ol type="1">
<li><strong>Estimar propensity score</strong></li>
<li><strong>Verificar overlap</strong></li>
<li><strong>Fazer pareamento</strong></li>
<li><strong>Verificar balance</strong></li>
<li><strong>Estimar efeito</strong></li>
</ol>
<ul>
<li><p>O que é Balance? *Balance significa que os grupos tratado e controle têm distribuições similares das covariáveis após o pareamento.</p></li>
<li><p>Objetivo: Se conseguimos balance perfeito, as únicas diferenças entre os grupos serão devido ao tratamento, não aos confounders.</p></li>
</ul>
<p>*|Diff.Adj| &lt; 0.1: Excelente balance</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Passo 1: Estimar propensity score</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>ps_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(treinamento <span class="sc">~</span> experiencia <span class="sc">+</span> <span class="fu">I</span>(experiencia<span class="sc">^</span><span class="dv">2</span>), </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> dados, <span class="at">family =</span> binomial)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>X  <span class="ot">&lt;-</span> ps_model<span class="sc">$</span>fitted</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>Y  <span class="ot">&lt;-</span> dados<span class="sc">$</span>produtividade</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>Tr  <span class="ot">&lt;-</span> dados<span class="sc">$</span>treinamento</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Passo 2: Verificar overlap</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>dados<span class="sc">$</span>pscore <span class="ot">&lt;-</span> <span class="fu">predict</span>(ps_model, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>dados <span class="sc">%&gt;%</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pscore, <span class="at">fill =</span> <span class="fu">factor</span>(treinamento))) <span class="sc">+</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">bins =</span> <span class="dv">25</span>) <span class="sc">+</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribuição dos Propensity Scores"</span>,</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Propensity Score"</span>, <span class="at">y =</span> <span class="st">"Frequência"</span>,</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Treinamento"</span>) <span class="sc">+</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/propensity-score-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Passo 3: Fazer pareamento</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>rr  <span class="ot">&lt;-</span> <span class="fu">Match</span>(<span class="at">Y=</span>Y, <span class="at">Tr=</span>Tr, <span class="at">X=</span>X, <span class="at">M=</span><span class="dv">1</span>);</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(rr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Estimate...  15.281 
AI SE......  0.9384 
T-stat.....  16.284 
p.val......  &lt; 2.22e-16 

Original number of observations..............  800 
Original number of treated obs...............  417 
Matched number of observations...............  417 
Matched number of observations  (unweighted).  571 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>mb  <span class="ot">&lt;-</span> <span class="fu">MatchBalance</span>(treinamento <span class="sc">~</span> experiencia <span class="sc">+</span> <span class="fu">I</span>(experiencia<span class="sc">^</span><span class="dv">2</span>),  <span class="at">data=</span>dados, <span class="at">match.out=</span>rr, <span class="at">nboots=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in ks.test.default(...): O valor-p será aproximado na presença de
empates
Warning in ks.test.default(...): O valor-p será aproximado na presença de
empates</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
***** (V1) experiencia *****
                       Before Matching       After Matching
mean treatment........     3.5041            3.5041 
mean control..........     5.9115            3.5064 
std mean diff.........    -106.34          -0.10125 

mean raw eQQ diff.....     2.4243           0.01421 
med  raw eQQ diff.....     1.9071         0.0079278 
max  raw eQQ diff.....     7.3303           0.29034 

mean eCDF diff........    0.20697         0.0025845 
med  eCDF diff........    0.23461         0.0017513 
max  eCDF diff........     0.3012          0.015762 

var ratio (Tr/Co).....    0.37858            1.0009 
T-test p-value........ &lt; 2.22e-16           0.14818 
KS Bootstrap p-value.. &lt; 2.22e-16                 1 
KS Naive p-value...... 3.7114e-16                 1 
KS Statistic..........     0.3012          0.015762 


***** (V2) I(experiencia^2) *****
                       Before Matching       After Matching
mean treatment........     17.391            17.391 
mean control..........     48.447            17.403 
std mean diff.........    -134.36         -0.050585 

mean raw eQQ diff.....     31.299          0.099713 
med  raw eQQ diff.....     15.674           0.04658 
max  raw eQQ diff.....     234.91            5.9291 

mean eCDF diff........    0.20697         0.0025845 
med  eCDF diff........    0.23461         0.0017513 
max  eCDF diff........     0.3012          0.015762 

var ratio (Tr/Co).....    0.14395           0.99165 
T-test p-value........ &lt; 2.22e-16           0.56036 
KS Bootstrap p-value.. &lt; 2.22e-16                 1 
KS Naive p-value...... 3.7114e-16                 1 
KS Statistic..........     0.3012          0.015762 


Before Matching Minimum p.value: &lt; 2.22e-16 
Variable Name(s): experiencia I(experiencia^2)  Number(s): 1 2 

After Matching Minimum p.value: 0.14818 
Variable Name(s): experiencia  Number(s): 1 </code></pre>
</div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>